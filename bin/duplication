#!/usr/bin/env ruby
# frozen_string_literal: true

$:.unshift(File.expand_path(File.join(File.dirname(__FILE__), "../lib")))
require "cc/logger"
require "cc/engine/duplication"

config =
  if File.exist?("/config.json")
    JSON.parse(File.read("/config.json"))
  else
    {}
  end

CC.logger.level =
  if config["debug"] || config.fetch("config", {})["debug"]
    ::Logger::DEBUG
  else
    ::Logger::INFO
  end

directory = ARGV[0] || "/code"

if ENV["CODECLIMATE_PROFILE"]
  require "stackprof"

  StackProf.start mode: :wall, out: "/code/profile.bin"
end

CC::Engine::Duplication.new(
  directory: directory, engine_config: config, io: STDOUT,
).run

if ENV["CODECLIMATE_PROFILE"]
  StackProf.stop
  StackProf.results
end
